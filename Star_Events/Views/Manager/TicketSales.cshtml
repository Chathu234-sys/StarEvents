@model IEnumerable<Star_Events.Data.Entities.TicketSale>

@{
    ViewData["Title"] = "Ticket Sales Dashboard";
    var eventDetails = ViewBag.EventDetails as Star_Events.Data.Entities.Event;
    var grouped = (IEnumerable<Star_Events.Models.ViewModels.TicketTypeSalesViewModel>)ViewBag.SalesGrouped ??
        Model.GroupBy(s => s.TicketType.Name).Select(g => new Star_Events.Models.ViewModels.TicketTypeSalesViewModel
        {
            TicketTypeName = g.Key,
            Quantity = g.Sum(x => x.Quantity),
            Amount = g.Sum(x => x.TotalAmount)
        }).ToList();

    var labels = string.Join(",", grouped.Select(s => $"'{s.TicketTypeName}'"));
    var quantities = string.Join(",", grouped.Select(s => s.Quantity));
    var revenues = string.Join(",", grouped.Select(s => s.Amount));
}

<div class="container mt-5">
    <!-- Event Header -->
    @if (eventDetails != null)
    {
        <div class="card bg-dark text-light mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="fw-bold mb-2">@eventDetails.Name</h2>
                        <p class="text-muted mb-1">@eventDetails.Description</p>
                        <div class="d-flex gap-3 small text-muted">
                            <span><i class="bi bi-calendar me-1"></i>@eventDetails.Date.ToString("MMM dd, yyyy")</span>
                            <span><i class="bi bi-clock me-1"></i>@eventDetails.Time.ToString(@"hh\:mm")</span>
                            <span><i class="bi bi-geo-alt me-1"></i>@eventDetails.Location</span>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="h4 text-success mb-0">Rs. @ViewBag.TotalRevenue.ToString("N0")</div>
                        <div class="small text-muted">Total Revenue</div>
                        <div class="small text-muted">@ViewBag.TotalTicketsSold tickets sold</div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Page Title -->
    <h3 class="fw-bold text-white mb-4">
        <i class="bi bi-graph-up-arrow text-success me-2"></i> Sales Analytics
    </h3>

    <!-- Chart Section -->
    <div class="row mb-5">
        <div class="col-md-6 mb-4">
            <div class="card shadow-lg border-0 rounded-4 p-3 bg-dark text-light">
                <h5 class="fw-bold">Sales by Quantity</h5>
                <canvas id="quantityChart"></canvas>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card shadow-lg border-0 rounded-4 p-3 bg-dark text-light">
                <h5 class="fw-bold">Revenue by Ticket Type</h5>
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
        <div class="col-md-12 mb-4">
            <div class="card shadow-lg border-0 rounded-4 p-3 bg-dark text-light">
                <h5 class="fw-bold">Daily Revenue (Line)</h5>
                <canvas id="dailyRevenueChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Sales Table -->
    <div class="card shadow-lg border-0 rounded-4 p-4 bg-dark text-light mb-4">
        <h4 class="fw-bold mb-3">Ticket Sales Summary (All Types)</h4>
        <div class="row row-cols-1 row-cols-md-3 g-3 mb-3">
            @foreach (var g in grouped)
            {
                <div class="col">
                    <div class="card bg-dark text-light p-3 h-100">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="fw-bold">@g.TicketTypeName</div>
                            <div class="text-success fw-bold">Rs. @g.Amount.ToString("N0")</div>
                        </div>
                        <div class="small text-muted">@g.Quantity tickets sold</div>
                        @if (g.Quantity == 0)
                        {
                            <div class="small text-warning">No sales yet</div>
                        }
                    </div>
                </div>
            }
        </div>
        <table class="table table-dark table-striped table-hover align-middle">
            <thead>
                <tr>
                    <th>Ticket Type</th>
                    <th>Quantity</th>
                    <th>Total Amount</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var sale in Model)
                {
                    <tr>
                        <td>@sale.TicketType.Name</td>
                        <td>@sale.Quantity</td>
                        <td>@sale.TotalAmount.ToString("C")</td>
                        <td>@sale.SaleDate.ToShortDateString()</td>
                    </tr>
                }
            </tbody>
        </table>
        <div class="row mt-3">
            <div class="col-md-4">
                <div class="alert alert-success">
                    <strong>Total Revenue: </strong> Rs. @ViewBag.TotalRevenue.ToString("N0")
                </div>
            </div>
            <div class="col-md-4">
                <div class="alert alert-info">
                    <strong>Total Tickets Sold: </strong> @ViewBag.TotalTicketsSold
                </div>
            </div>
            <div class="col-md-4">
                <div class="alert alert-warning">
                    <strong>Total Sales: </strong> @ViewBag.TotalSalesCount transactions
                </div>
            </div>
        </div>
    </div>

    <!-- Export Buttons -->
    <div class="d-flex gap-3">
        <a asp-action="ExportToPdf" class="btn btn-danger">
            <i class="bi bi-file-earmark-pdf me-1"></i> Download PDF
        </a>
        <a asp-action="ExportToExcel" class="btn btn-success">
            <i class="bi bi-file-earmark-excel me-1"></i> Download Excel
        </a>
        <a asp-action="ExportToCsv" class="btn btn-primary">
            <i class="bi bi-filetype-csv me-1"></i> Download CSV
        </a>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const labels = [@Html.Raw(labels)];
    const quantities = [@Html.Raw(quantities)];
    const revenues = [@Html.Raw(revenues)];
    const dailyLabels = [@Html.Raw(ViewBag.DailyLabels ?? "")];
    const dailyAmounts = [@Html.Raw(ViewBag.DailyAmounts ?? "")];

    // Quantity Chart
    new Chart(document.getElementById("quantityChart"), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: "Quantity Sold",
                data: quantities,
                backgroundColor: "rgba(54, 162, 235, 0.7)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 1
            }]
        }
    });

    // Revenue Chart
    new Chart(document.getElementById("revenueChart"), {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                label: "Revenue",
                data: revenues,
                backgroundColor: [
                    "#ff6384", "#36a2eb", "#ffcd56", "#4bc0c0", "#9966ff", "#ff9f40"
                ]
            }]
        }
    });

    // Daily Revenue Line Chart
    new Chart(document.getElementById('dailyRevenueChart'), {
        type: 'line',
        data: {
            labels: dailyLabels,
            datasets: [{
                label: 'Revenue by day',
                data: dailyAmounts,
                borderColor: '#02e2f7',
                backgroundColor: 'rgba(2, 226, 247, 0.2)',
                tension: 0.3,
                fill: true,
                pointRadius: 3
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>

<style>
    body {
        background-color: #0d1117; /* Dark mode */
        font-family: 'Segoe UI', sans-serif;
    }

    h2, h4, h5 {
        color: #fff;
    }

    .card {
        background: #1c1f26;
    }

    .table thead {
        background-color: #212529;
    }
</style>
